{% extends 'layout.html' %}
{% block title %}Editar Pregunta{% endblock %}
{% block content %}
<div class="dashboard-header">
  <h2>锔 Editar Pregunta</h2>
  <p class="welcome">{{ examen.titulo }}</p>
</div>

<form method="post" class="auth-form">
  <div class="form-group">
    <label for="texto">Enunciado de la pregunta *</label>
    <textarea name="texto" id="texto" rows="4" required class="form-control">{{ pregunta.texto }}</textarea>
  </div>

  <div class="form-group">
    <label for="tipo">Tipo de pregunta *</label>
    <select name="tipo" id="tipo" required class="form-control" onchange="cambiarTipoPregunta()">
      <option value="opcion_multiple" {{ 'selected' if pregunta.tipo == 'opcion_multiple' }}>Opci贸n M煤ltiple</option>
      <option value="verdadero_falso" {{ 'selected' if pregunta.tipo == 'verdadero_falso' }}>Verdadero o Falso</option>
      <option value="abierta" {{ 'selected' if pregunta.tipo == 'abierta' }}>Respuesta Abierta</option>
    </select>
  </div>

<div class="col-md-6">
                        <label for="puntos" class="form-label">
                            <i class="bi bi-star"></i> Puntos
                        </label>
                        <input type="number" class="form-control" id="puntos" name="puntos" value="{{ pregunta.puntos }}" min="1" step="1" required>
                    </div>
                    <div class="col-md-6">
                        <label for="tiempo_estimado" class="form-label">
                            <i class="bi bi-hourglass-split"></i> Tiempo Estimado (segundos)
                        </label>
                        <input type="number" class="form-control" id="tiempo_estimado" name="tiempo_estimado" value="{{ pregunta.tiempo_estimado }}" min="15" step="15" required>
                    </div>

  <div class="form-group">
    <label for="nivel_dificultad">Nivel de Dificultad </label>
    <select name="nivel_dificultad" id="nivel_dificultad" class="form-control">
      <option value="basico" {{ 'selected' if pregunta.nivel_dificultad == 'basico' }}> B谩sico</option>
      <option value="intermedio" {{ 'selected' if pregunta.nivel_dificultad == 'intermedio' }}> Intermedio</option>
      <option value="avanzado" {{ 'selected' if pregunta.nivel_dificultad == 'avanzado' }}> Avanzado</option>
    </select>
  </div>

  <div class="form-group">
    <label for="explicacion">Explicaci贸n de la respuesta correcta </label>
    <textarea name="explicacion" id="explicacion" rows="3" class="form-control" 
              placeholder="Explica por qu茅 esta es la respuesta correcta (se mostrar谩 despu茅s de responder)">{{ pregunta.explicacion }}</textarea>
    <small>Esta explicaci贸n ayudar谩 a los estudiantes a aprender de sus errores</small>
  </div>

  <!-- Opciones para Opci贸n M煤ltiple -->
  <div id="opcion_multiple_section" class="hidden-section">
    <div class="form-group">
      <label>Opciones de respuesta</label>
      <div id="opciones_container">
        {% if pregunta.tipo == 'opcion_multiple' %}
          {% set opciones = pregunta.opciones|from_json %}
          {% for opcion in opciones %}
            <div class="opcion-item">
              <input type="text" name="opcion_{{ loop.index }}" value="{{ opcion.texto }}" placeholder="Opci贸n {{ loop.index }}" class="form-control">
            </div>
          {% endfor %}
        {% else %}
          <div class="opcion-item">
            <input type="text" name="opcion_1" placeholder="Opci贸n 1" class="form-control">
          </div>
          <div class="opcion-item">
            <input type="text" name="opcion_2" placeholder="Opci贸n 2" class="form-control">
          </div>
        {% endif %}
      </div>
      <button type="button" onclick="agregarOpcion()" class="btn btn-sm btn-secondary">+ Agregar opci贸n</button>
    </div>
    
    <div class="form-group">
      <label for="respuesta_correcta_om">Respuesta correcta *</label>
      <select name="respuesta_correcta" id="respuesta_correcta_om" class="form-control">
        <option value="">Selecciona la opci贸n correcta</option>
        {% if pregunta.tipo == 'opcion_multiple' %}
          {% set opciones = pregunta.opciones|from_json %}
          {% set respuesta_correcta_texto = (opciones|selectattr('correcta', 'equalto', true)|first).texto %}
          {% for opcion in opciones %}
            <option value="{{ opcion.texto }}" {{ 'selected' if opcion.texto == respuesta_correcta_texto }}>{{ opcion.texto }}</option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
  </div>

  <!-- Opciones para Verdadero/Falso -->
  <div id="verdadero_falso_section" class="hidden-section">
    <div class="form-group">
      <label>Respuesta correcta *</label>
      <div class="radio-group">
        <label class="radio-label">
          <input type="radio" name="respuesta_correcta_vf" value="Verdadero" {{ 'checked' if pregunta.respuesta_correcta == 'Verdadero' }}>
          <span>Verdadero</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="respuesta_correcta_vf" value="Falso" {{ 'checked' if pregunta.respuesta_correcta == 'Falso' }}>
          <span>Falso</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Opciones para Respuesta Abierta -->
  <div id="abierta_section" class="hidden-section">
    <div class="form-group">
      <label for="respuesta_sugerida">Respuesta sugerida (opcional)</label>
      <textarea name="respuesta_abierta" id="respuesta_sugerida" rows="3" class="form-control" 
                placeholder="Escribe una respuesta modelo o criterios de evaluaci贸n">{{ pregunta.respuesta_correcta if pregunta.tipo == 'abierta' }}</textarea>
    </div>
  </div>

  <div class="form-actions">
    <a href="{{ url_for('profesor.gestionar_preguntas', id=examen.id) }}" class="btn btn-secondary">Cancelar</a>
    <button type="submit" class="btn btn-primary"> Guardar Cambios</button>
  </div>
</form>

<script>
let opcionCounter = {{ (pregunta.opciones|from_json)|length if pregunta.tipo == 'opcion_multiple' else 2 }};

function cambiarTipoPregunta() {
  const tipo = document.getElementById('tipo').value;
  
  document.getElementById('opcion_multiple_section').classList.add('hidden-section');
  document.getElementById('verdadero_falso_section').classList.add('hidden-section');
  document.getElementById('abierta_section').classList.add('hidden-section');
  
  if (tipo === 'opcion_multiple') {
    document.getElementById('opcion_multiple_section').classList.remove('hidden-section');
    actualizarSelectRespuesta();
  } else if (tipo === 'verdadero_falso') {
    document.getElementById('verdadero_falso_section').classList.remove('hidden-section');
  } else if (tipo === 'abierta') {
    document.getElementById('abierta_section').classList.remove('hidden-section');
  }
}

function agregarOpcion() {
  opcionCounter++;
  const container = document.getElementById('opciones_container');
  const div = document.createElement('div');
  div.className = 'opcion-item';
  div.innerHTML = `<input type="text" name="opcion_${opcionCounter}" placeholder="Opci贸n ${opcionCounter}" class="form-control" onchange="actualizarSelectRespuesta()">`;
  container.appendChild(div);
  actualizarSelectRespuesta();
}

function actualizarSelectRespuesta() {
  const select = document.getElementById('respuesta_correcta_om');
  const valorActual = select.value;
  select.innerHTML = '<option value="">Selecciona la opci贸n correcta</option>';
  
  const inputs = document.querySelectorAll('#opciones_container input[type="text"]');
  inputs.forEach((input, index) => {
    if (input.value.trim() !== '') {
      const option = document.createElement('option');
      option.value = input.value;
      option.textContent = input.value;
      if (input.value === valorActual) {
        option.selected = true;
      }
      select.appendChild(option);
    }
  });
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
  cambiarTipoPregunta();
  
  const inputs = document.querySelectorAll('#opciones_container input[type="text"]');
  inputs.forEach(input => {
    input.addEventListener('input', actualizarSelectRespuesta);
  });
});
</script>
{% endblock %}
