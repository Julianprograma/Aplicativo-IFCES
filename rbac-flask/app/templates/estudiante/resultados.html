{% extends "layout.html" %}

{% block title %}Mis Resultados - IFCES{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">üìä Mis Resultados</h1>
        <a href="{{ url_for('main.dashboard_estudiante') }}" class="btn btn-outline-secondary">
            ‚Üê Volver al Dashboard
        </a>
    </div>

    <!-- Estad√≠sticas Generales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-file-earmark-text text-primary fs-1"></i>
                    <h3 class="mt-2">{{ total }}</h3>
                    <p class="text-muted mb-0">Ex√°menes Presentados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-graph-up text-info fs-1"></i>
                    <h3 class="mt-2">{{ "%.1f"|format(promedio) }}%</h3>
                    <p class="text-muted mb-0">Promedio General</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-check-circle text-success fs-1"></i>
                    <h3 class="mt-2">{{ aprobados }}</h3>
                    <p class="text-muted mb-0">Ex√°menes Aprobados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-trophy text-warning fs-1"></i>
                    <h3 class="mt-2">{{ "%.1f"|format(mejor_nota) }}%</h3>
                    <p class="text-muted mb-0">Mejor Calificaci√≥n</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Resultados -->
    {% if not resultados %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> A√∫n no has presentado ning√∫n examen.
    </div>
    {% else %}
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-list-check"></i> Historial de Ex√°menes</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Examen</th>
                            <th>Categor√≠a</th>
                            <th>Fecha</th>
                            <th class="text-center">Calificaci√≥n</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for resultado in resultados %}
                        <tr>
                            <td>
                                <strong>{{ resultado.examen.titulo }}</strong>
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> {{ resultado.tiempo_utilizado // 60 if resultado.tiempo_utilizado else 0 }} min
                                </small>
                            </td>
                            <td>
                                {% if resultado.examen.categoria %}
                                <span class="badge" style="background-color: {{ resultado.examen.categoria.color }}">
                                    {{ resultado.examen.categoria.icono }} {{ resultado.examen.categoria.nombre }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">üìö General</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ resultado.fecha_presentacion.strftime('%d/%m/%Y') if resultado.fecha_presentacion else 'N/A' }}
                                <br>
                                <small class="text-muted">
                                    {{ resultado.fecha_presentacion.strftime('%H:%M') if resultado.fecha_presentacion else '' }}
                                </small>
                            </td>
                            <td class="text-center">
                                <div class="d-flex flex-column align-items-center">
                                    <span class="fs-4 fw-bold {% if resultado.calificacion >= (resultado.examen.calificacion_minima or 60) %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.1f"|format(resultado.calificacion) }}%
                                    </span>
                                    {% if resultado.calificacion >= 90 %}
                                        <small class="badge bg-success">Excelente</small>
                                    {% elif resultado.calificacion >= (resultado.examen.calificacion_minima or 60) %}
                                        <small class="badge bg-primary">Aprobado</small>
                                    {% else %}
                                        <small class="badge bg-danger">Reprobado</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-center">
                                {% if resultado.calificacion >= (resultado.examen.calificacion_minima or 60) %}
                                    <span class="badge bg-success">‚úì Aprobado</span>
                                {% else %}
                                    <span class="badge bg-danger">‚úó Reprobado</span>
                                {% endif %}
                                {% if resultado.comentario_profesor %}
                                    <br><span class="badge bg-info mt-1">üí¨ Con comentarios</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('main.estudiante_detalle_resultado', resultado_id=resultado.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> Ver Detalles
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Progreso (√öltimos 10 ex√°menes) -->
    {% if resultados|length > 1 %}
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Progreso Reciente</h5>
        </div>
        <div class="card-body">
            <canvas id="graficoProgreso" style="max-height: 300px;"></canvas>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

{% if resultados|length > 1 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos para el gr√°fico
const resultadosData = [
    {% for resultado in resultados|reverse|slice(0, 10) %}
    {
        titulo: "{{ resultado.examen.titulo[:20] }}...",
        calificacion: {{ resultado.calificacion }},
        fecha: "{{ resultado.fecha_presentacion.strftime('%d/%m') if resultado.fecha_presentacion else '' }}"
    },
    {% endfor %}
].reverse();

const ctx = document.getElementById('graficoProgreso').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: resultadosData.map(r => r.fecha + '\n' + r.titulo),
        datasets: [{
            label: 'Calificaci√≥n (%)',
            data: resultadosData.map(r => r.calificacion),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Calificaci√≥n: ' + context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
